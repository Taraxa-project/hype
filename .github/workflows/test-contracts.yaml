name: Build and Deploy
on:
  push:
    paths:
      - services/contracts/**
  pull_request:
    paths:
      - services/contracts/**
    types: [opened, synchronize, closed]
jobs:
  test-contracts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v3
      - name: Setup NodeJS 16
        uses: actions/setup-node@v2
        with:
          node-version: 16.x
      - name: Show NodeJS version    
        run: node -v
      - name: Install and Build üîß # This example project is built using npm and outputs the result to the 'build' folder. Replace with the commands required to build your project, or remove this step entirely if your site is pre-built.
        run: |
          yarn
          yarn 
      - name: Compile contracts
        run: yarn compile-contracts
      - name: Run Hardhat tests with coverage
        run: yarn test-contracts:coverage
      - name: Setup Python 3.8  
        uses: actions/setup-python@v2
        with:
          python-version: 3.8 # Version range or exact version of a Python version to use, using SemVer's version range syntax
          architecture: 'x64' # optional x64 or x86. Defaults to x64 if not specified
      - name: Show Python version
        run: python --version
      - name: Clone SmartBugs Repo
        run: git clone https://github.com/smartbugs/smartbugs.git
      - name: Remove SmartBugs Results and Install SmartBugs Dependencies
        run: cd smartbugs;rm -r results;pip install -r requirements.txt
      - name: Run SmartBugs Analysis
        run: |
          solidityFiles=($(find services/contracts/contracts -type f -name "*.sol"))
          DIR=$(pwd);cd smartbugs
          for sol in "${solidityFiles[@]}"
          do
            echo "Analysing $sol..."
            python smartBugs.py --tool all --file $DIR/contracts/$sol
          done
      - name: Move SmartBugs Results to Parent Directory
        run: |
          [[ -d results ]] && rm -r results
          cd smartbugs
          mv results ../
      - name: Commit SmartBugs Results
        uses: EndBug/add-and-commit@v7
        with:
          author_name: github-actions
          author_email: action@github.com
          message: 'chore: added smartbugs results'
          add: 'results'